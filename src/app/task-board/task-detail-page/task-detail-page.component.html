<div class="task-wrapper">
  <div *ngIf="loading">
    <div class="text-center" style="margin-top: 40vh;">
      <i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw text-warning"></i>
      <!--<span class="sr-only">Loading...</span>-->
    </div>
  </div>
  <div *ngIf="!loading" class="container-fluid pl-5 pr-5">
    <div class="row currentTask?-brief mt-3">
      <div class="col-md-6 col-lg-8">
        <h3>{{task?.title}}</h3>

        <div style="font-size:15px;">
          Due on <span class="font-weight-bold" [ngClass]="(task?.isDueToday())? 'text-danger' : ''">
          {{task?.dueDate | date:'MMM dd, yyyy, hh:mm a'}}</span>
        </div>
        <div class="mt-1">
          <!--<span>{{task?.projectName}}</span><br>-->
          <span class="small">Assigned To {{task.assignedTo}}</span> <br>
          <span class="small">Created by {{task?.owner}} on {{task?.createdAt | date:'MMM d, y, h:mm a' }}</span><br>
          <span class="small font-italic">{{task?.desc}}</span>
          <div class="mt-3 mb-1">
            <span class="font-weight-bold small">Users watching this task</span><br>
            <div *ngIf="task?.watchers.length != 0; else nowatchers">
              <div class="d-inline-block mt-2" *ngFor="let watcher of task?.watchers">
                <div class="watcher ml-1 btnfont-italic">
                  <span class="small">{{watcher}}</span>
                  <!--<span class="fa fa-fw fa-remove text-secondary text-right" *ngIf="task.getUserRole(this.loggedInUser) === 'ROLE_ASSIGNEE'" (click)="deleteWatcher(watcher)"></span>-->
                </div>
              </div>
            </div>
            <ng-template #nowatchers>
              <span class="small text-muted font-italic">No watchers for this task</span>
            </ng-template>


          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-4 text-right">

        <div style="font-size:25px;">{{task?.completionPercent}}%</div>
        <div class="progress" style="height:5px;">
          <div class="progress-bar" [ngClass]="task.getProgressBarColor()" role="progressbar"
               [style.width]="task?.completionPercent+'%'"
               aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="mt-3 btn-block-mobile">
          <div *ngIf="task?.getUserRole(this.loggedInUser) === 'ROLE_ASSIGNEE'"
               class="btn btn-outline-info btn-lg btn-round mt-2" data-toggle="modal"
               [attr.data-target]="'#updateStatusModal'+task?._id"><span class="fa fa-fw fa-sm fa-plus"></span> Status
          </div>
          <div *ngIf="task?.getUserRole(this.loggedInUser) === 'ROLE_WATCHER'"
               class="btn unsubscribe btn-outline-danger btn-lg btn-round mt-2" data-toggle="modal"
               [attr.data-target]="'#unsubscribeModal'+task?._id"><span class="fa fa-fw fa-sm fa-eye-slash"></span>
            Unsubscribe
          </div>
          <div *ngIf="task?.getUserRole(this.loggedInUser) === 'ROLE_NONE'"
               class="btn subscribe btn-outline-success btn-lg btn-round mt-2" data-toggle="modal"
               [attr.data-target]="'#subscribeModal'+task?._id"><span class="fa fa-fw fa-sm fa-eye"></span> Subscribe
          </div>


        </div>
      </div>
    </div>

    <div>
      <div *ngIf="task.getUserRole(this.loggedInUser) === 'ROLE_ASSIGNEE'">
        <div class="task-actions mt-3 mb-2 btn-block-mobile">
          <button class="btn btn btn-outline-primary btn-round mr-2 margin-top4-mobile" data-toggle="modal"
                  [attr.data-target]="'#editTaskModal'+task?._id" (click)="resetCurrentTask()"><span class="fa fa-fw fa-pencil"></span> Edit
          </button>
          <button class="btn btn btn-outline-warning btn-round mr-2 margin-top4-mobile" data-toggle="modal"
                  [attr.data-target]="'#reAssignTaskModal'+task?._id"><span class="fa fa-fw fa-reply"></span> Re-Assign
          </button>
          <button class="btn btn btn-outline-danger btn-round mr-2 margin-top4-mobile" data-toggle="modal"
                  [attr.data-target]="'#deleteTaskModal'+task?._id"><span class="fa fa-fw fa-trash"></span> Delete
          </button>
        </div>
      </div>
      <div class=" timeline mt-3 pt-3">
        <h4 class="text-muted history-header">Timeline</h4>
        <div class="pre-scrollable container-fluid mt-3">
          <div class="task-recent-status history" *ngFor="let status of task?.statusUpdates">
            <span class="fa fa-fw fa-circle small"></span>
            <span class="small text-muted history-label">
       <span style="font-weight: 500" class="ml-1">{{status.createdAt | date:'MMM d, y, h:mm a'}} | </span> <span class="font-weight-bold">{{(status.percentage)? status.percentage: 0}}%</span>
      <span class="d-none d-md-inline-block d-lg-inline-block">| </span><span class="task-item-mobile ml-2-mobile">  @{{status.updateBy}}</span>
    </span>
            <div class="description " [ngClass]="(status.flag == 'SYSTEM_AUDIT')? 'text-muted small font-italic' : ''"><pre class="status-description">{{status.desc}} </pre></div>
          </div>
          <!--<div class="task-recent-status history">
            <span class="fa fa-fw fa-circle small"></span>
            <span class="small text-muted history-label">
      <span style="font-weight: 500" class="ml-1">{{task?.createdAt | date:'MMM d, y, h:mm a'}}</span>
      <strong> | {{task?.owner}}</strong>
    </span>
            <p class="description text-muted small">Task was created
            </p>
          </div>-->
        </div>
      </div>
    </div>
  </div>

</div>
  <!--Add Status modal-->
  <div class="modal fade addStatus-modal" [attr.id]="'updateStatusModal'+task?._id" tabindex="-1" role="dialog"
       aria-labelledby="updateStatusModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header text-light">
          <h5 class="modal-title" id="updateStatusModalLabel">Status Update</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close"
                  (click)="resetCurrentTask()">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form #addStatusForm="ngForm">
          <div class="modal-body">
            <div class="form-group">
              <strong>{{currentTask?.title}}</strong>
              <!--<span *ngIf="currentTask?.projectName">| <span class="text-muted">{{currentTask?.projectName}}</span></span>-->
            </div>
            <div class="form-group">
              <label>Completion Percentage</label>
              <div class="row">
                <div class="col-10">
                  <input autocomplete="off" type="range" max="100" name="completionPercent"
                         [(ngModel)]="currentTask.completionPercent" #completionPercent="ngModel">
                </div>
                <div class="form-group col-2">
                  <input type="text" class="p-2 text-center"
                         style="border: 1px solid; border-radius: 40px;color: #00aae7; width: 50px" minlength="1"
                         maxlength="3" name="a" [ngModel]="currentTask.completionPercent" readonly>
                </div>

              </div>
            </div>
            <div class="form-group">
              <label>Description<span class="text-danger"><sup>*</sup></span></label>

              <textarea class="form-control" name="desc" #statusDescription="ngModel" [(ngModel)]="statusDesc"
                        placeholder="Status update goes here."
                        maxlength="160"
                        required minlength="20"></textarea>
              <small>
                <code
                  [ngClass]="(statusDesc.length > 19)? 'text-success' : 'text-danger'">({{statusDesc.length}}/160)</code>
              </small>

              <!-- <div *ngIf="statusDescription.invalid && (statusDescription.dirty || statusDescription.touched)"
                    class="text-danger small ">
                 <div *ngIf="statusDescription.errors.required">
                   Description is required.
                 </div>
                 <div *ngIf="statusDescription.errors.minlength">
                   Description must be at least 20 characters long.
                 </div>
               </div>-->
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-round" data-dismiss="modal"
                    (click)="resetCurrentTask()"><span class="fa fa-fw fa-times-circle"></span> Cancel
            </button>
            <button type="button" class="btn btn-round addStatus-btn"
                    [disabled]="(!addStatusForm.form.valid || (task?.completionPercent !=100 && currentTask.completionPercent < task?.completionPercent))"
                    [ngClass]="(!addStatusForm.form.valid || (task?.completionPercent !=100 && currentTask.completionPercent < task?.completionPercent))? 'disabled' : ''"
                    data-dismiss="modal"
                    (click)="addStatus(addStatusForm.value)"><span class="fa fa-fw fa-plus"></span> Status
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--Add status modal ends-->

  <!--Edit task modal-->
  <div class="modal fade" [attr.id]="'editTaskModal'+task?._id" tabindex="-1" role="dialog"
       aria-labelledby="editTaskModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form #editTaskForm="ngForm">
          <div class="modal-header bg-primary text-light">
            <h5 class="modal-title" id="createTaskModalLabel">Edit Task</h5>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close"
                    (click)="d.close();resetCurrentTask()">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">

            <!--  <div class="form-group">
                <label>Project Name <span class="text-danger"><sup>*</sup></span></label>
                <input autocomplete="off" type="text" class="form-control form-control-sm" id="projectName" name="projectName"
                       placeholder="Project Name" [ngModel]="currentTask.projectName" readonly minlength="5" maxlength="50">
              </div>-->
            <div class="form-group">
              <label>Title<span class="text-danger"><sup>*</sup></span></label>
              <input autocomplete="off" type="text" class="form-control form-control-sm" id="title" name="title"
                     placeholder="Title"
                     #title="ngModel" [(ngModel)]="currentTask.title" required minlength="10" maxlength="50">
              <small><code [ngClass]="(currentTask.title.length > 9)? 'text-success' : 'text-danger'">({{currentTask.title.length}}/50)</code>
              </small>
            </div>
            <div class="form-group">
              <label>Description<span class="text-danger"><sup>*</sup></span></label>
              <textarea class="form-control" id="desc" #description="ngModel" name="desc"
                        placeholder="Tell us more about the task" ngModel rows="3"
                        maxlength="160" minlength="20"
                        [(ngModel)]="currentTask.desc" required></textarea>
              <small><code [ngClass]="(currentTask.desc.length > 19)? 'text-success' : 'text-danger'">({{currentTask.desc.length}}/160)</code>
              </small>
            </div>
            <div class="form-group">
              <label>Assign To<span class="text-danger"><sup>*</sup></span></label>
              <div ngbDropdown placement="top" #assigneeDropDown="ngbDropdown">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fa fa-fw fa-user-o"></span></span>
                  </div>
                  <input autocomplete="off" type="text" class="form-control form-control-sm" id="assignedTo"
                         name="assignedTo"
                         placeholder="Assign To" aria-label="Assign To" aria-describedby="user-icon"
                         (keyup)="getSuggestion($event, 'assignee');assigneeDropDown.open();" ngbDropdownAnchor
                         #assignee="ngModel" [(ngModel)]="assignId" required>
                </div>
                <div ngbDropdownMenu *ngIf="empListAssignee.length > 0">
                  <div *ngFor="let emp of empListAssignee">
                    <button class="dropdown-item" (click)="addAssignee(emp);">{{emp?.EmployeeName}}</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Watchers</label>
              <div ngbDropdown placement="top" #watcherDropDown="ngbDropdown">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text"><span class="fa fa-fw fa-users"></span></span>
                  </div>
                  <input autocomplete="off" type="text" class="form-control form-control-sm" id="watcher" name="watcher"
                         placeholder="Add a Watcher" aria-label="Add a Watcher" aria-describedby="user-group"
                         (keyup)="getSuggestion($event, 'watcher');watcherDropDown.open();" data-role="tagsinput" #watcher
                         ngbDropdownAnchor [(ngModel)]="watcherName">

                </div>

                <div ngbDropdownMenu *ngIf="empListWatcher.length > 0">
                  <div *ngFor="let emp of empListWatcher">
                    <button class="dropdown-item" (click)="addWatcher(emp);">{{emp?.EmployeeName}}</button>
                  </div>
                </div>
              </div>
              <div class="d-inline-block mt-2" *ngFor="let watcher of currentTask?.watchers">
                <div class="watcher ml-1 btn " (click)="deleteWatcher(watcher)">{{watcher}}<span
                  class="fa fa-fw fa-remove text-danger"></span></div>
              </div>
            </div>
            <div class="form-group">
              <label>Due Date<span class="text-danger"><sup>*</sup></span></label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><span class="fa fa-fw fa-calendar" (click)="d.toggle()"></span></span>
                </div>

                <input autocomplete="off" class="form-control form-control-sm" placeholder="YYYY-MM-DD" type="text"
                       id="dueDate"
                       name="dueDate" [(ngModel)]="dueDate"
                       #d1="ngModel" ngbDatepicker #d="ngbDatepicker"
                       [minDate]="minDate"
                       [autoClose]="true" (click)="d.toggle()" required>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-round" data-dismiss="modal"
                    (click)="d.close();resetCurrentTask()"><span
              class="fa fa-fw fa-times-circle"></span> Cancel
            </button>
            <button type="button" class="btn btn-outline-primary btn-round" data-dismiss="modal"
                    [disabled]="!editTaskForm.form.valid" [ngClass]="!editTaskForm.form.valid? 'disabled' : ''"
                    (click)="editTask(editTaskForm.value)"><span class="fa fa-fw fa-pencil"></span>
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--Edit task modal ends-->

  <!--Delete Task modal-->
  <div class="modal fade" [attr.id]="'deleteTaskModal'+task?._id" tabindex="-1" role="dialog"
       aria-labelledby="deleteTaskModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-danger text-light">
          <h5 class="modal-title " id="deleteTaskModalLabel">Delete Task</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <form #deleteTaskForm="ngForm">
          <div class="modal-body">
            <div class="form-group">
              <strong>{{currentTask?.title}}</strong>
              <!--<span *ngIf="currentTask?.projectName">| <span class="text-muted">{{currentTask?.projectName}}</span></span>-->
            </div>
            <span class="text-muted small">Created By: </span><span> {{currentTask?.owner}}</span><br>
            <span class="text-muted small">Created On: </span><span> {{currentTask?.createdAt | date:'MMM d, y, h:mm a'}}</span><br>
            <span class="text-muted small">Due On: </span><span
            [ngClass]="currentTask.isDueToday()? 'text-danger' : ''"> {{currentTask?.dueDate | date:'MMM d, y, h:mm a'}}</span><br>
            <span
              class="text-muted small">Percentage Completion: </span><span> {{currentTask?.completionPercent}}</span><br>
            <span class="text-muted small">Description: </span><br>
            <blockquote>{{currentTask?.desc}}</blockquote>
            <hr>
            <p class="h5">This task will be deleted permanently !</p>
            <p>Are you sure you want to delete?</p>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-round" data-dismiss="modal"><span
              class="fa fa-fw fa-times-circle"></span> Cancel
            </button>
            <button type="button" class="btn btn-outline-danger btn-round" data-dismiss="modal" (click)="deleteTask()">
              <span class="fa fa-fw fa-trash"></span> Delete
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--Delete status modal ends-->

  <!--Subscribe Task modal-->
  <div class="modal fade" [attr.id]="'subscribeModal'+task?._id" tabindex="-1" role="dialog"
       aria-labelledby="subscribeModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-success text-light">
          <h5 class="modal-title" id="subscribeModalLabel">Subscribe</h5>
          <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <form #subscribeForm="ngForm">
          <div class="modal-body">
            <div class="form-group">
              <strong>{{currentTask?.title}}</strong>
              <!--<span *ngIf="currentTask?.projectName">| <span class="text-muted">{{currentTask?.projectName}}</span></span>-->
            </div>
            <span class="text-muted small">Created By: </span><span> {{currentTask?.owner}}</span><br>
            <span class="text-muted small">Created On: </span><span> {{currentTask?.createdAt | date:'MMM d, y, h:mm a'}}</span><br>
            <span class="text-muted small">Due On: </span><span
            [ngClass]="currentTask.isDueToday()? 'text-danger' : ''"> {{currentTask?.dueDate | date:'MMM d, y, h:mm a'}}</span><br>
            <span
              class="text-muted small">Percentage Completion: </span><span> {{currentTask?.completionPercent}}</span><br>
            <span class="text-muted small">Description: </span><br>
            <blockquote>{{currentTask?.desc}}</blockquote>
            <hr>
            <p class="h5">You will recieve a notification every time the task is updated!</p>
            <p>Are you sure you want to subscribe?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-round" data-dismiss="modal"><span
              class="fa fa-fw fa-times-circle"></span> Cancel
            </button>
            <button type="button" class="btn btn-outline-success btn-round" data-dismiss="modal" (click)="subscribe()">
              <span class="fa fa-fw fa-eye"></span> Subscribe
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--Subscribe Task modal ends-->

  <!--Unsubscribe Task modal-->
  <div class="modal fade" [attr.id]="'unsubscribeModal'+task?._id" tabindex="-1" role="dialog"
       aria-labelledby="unsubscribeModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="unsubscribeModalLabel">Warning!</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form #unsubscribeForm="ngForm">
          <div class="modal-body">
            <div class="form-group">
              <strong>{{currentTask?.title}}</strong>
              <!--<span *ngIf="currentTask?.projectName">| <span class="text-muted">{{currentTask?.projectName}}</span></span>-->
            </div>
            <span class="text-muted small">Created By: </span><span> {{currentTask?.owner}}</span><br>
            <span class="text-muted small">Created On: </span><span> {{currentTask?.createdAt | date:'MMM d, y, h:mm a'}}</span><br>
            <span class="text-muted small">Due On: </span><span
            [ngClass]="currentTask.isDueToday()? 'text-danger' : ''"> {{currentTask?.dueDate | date:'MMM d, y, h:mm a'}}</span><br>
            <span
              class="text-muted small">Percentage Completion: </span><span> {{currentTask?.completionPercent}}</span><br>
            <span class="text-muted small">Description: </span><br>
            <blockquote>{{currentTask?.desc}}</blockquote>
            <hr>
            <p class="h5">You will stop receiving notifications <br> for this task !</p>
            <p>Are you sure you want to subscribe?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-round" data-dismiss="modal"><span
              class="fa fa-fw fa-times-circle"></span> Cancel
            </button>
            <button type="button" class="btn btn-outline-danger btn-round" data-dismiss="modal" (click)="unsubscribe()">
              <span class="fa fa-fw fa-eye-slash"></span> Unsubscribe
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--Unsubscribe Task modal ends-->


  <!--Re-Assign Task modal-->
  <div class="modal fade" [attr.id]="'reAssignTaskModal'+task?._id" #reAssignTaskModal tabindex="-1" role="dialog"
       aria-labelledby="reAssignTaskModalLabel"
       aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="reAssignTaskModalLabel">Re-Assign Task</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" (click)="resetCurrentTask()">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <form #reAssignForm="ngForm">
          <div class="modal-body">
            <div class="form-group">
              <strong>{{currentTask?.title}}</strong>
              <!--<span *ngIf="currentTask?.projectName">| <span class="text-muted">{{currentTask?.projectName}}</span></span>-->
            </div>
            <span class="text-muted small">Created By: </span><span> {{currentTask?.owner}}</span><br>
            <span class="text-muted small">Created On: </span><span> {{currentTask?.createdAt | date:'MMM d, y, h:mm a'}}</span><br>
            <span class="text-muted small">Due On: </span><span
            [ngClass]="currentTask.isDueToday()? 'text-danger' : ''"> {{currentTask?.dueDate | date:'MMM d, y, h:mm a'}}</span><br>
            <span
              class="text-muted small">Percentage Completion: </span><span> {{currentTask?.completionPercent}}</span><br>
            <label class="mt-4">Assign To<span class="text-danger"><sup>*</sup></span></label><br>
            <div ngbDropdown placement="bottom" #reassignDropDown="ngbDropdown">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text"><span class="fa fa-fw fa-user-o"></span></span>
                </div>
                <input autocomplete="off" type="text" class="form-control form-control-sm" id="reassignedTo"
                       name="reassignedTo"
                       placeholder="Assign To" aria-label="Assign To" aria-describedby="user-icon"
                       (keydown)="getSuggestion($event,'assignee');reassignDropDown.open();" ngbDropdownAnchor
                       [(ngModel)]="assignId" #reassginee="ngModel" required>
              </div>
              <div ngbDropdownMenu *ngIf="empListAssignee.length > 0">
                <div *ngFor="let emp of empListAssignee">
                  <button class="dropdown-item" (click)="addAssignee(emp);">{{emp?.EmployeeName}}</button>
                </div>
              </div>
            </div>
            <hr>
            <p class="h5">You wont be able to make any more changes to this task!</p>
            <p>Are you sure you want to Re-Assign?</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary btn-round" data-dismiss="modal"
                    (click)="resetCurrentTask()"><span class="fa fa-fw fa-times-circle"></span> Cancel
            </button>
            <button type="button" class="btn btn-outline-warning btn-round" data-dismiss="modal"
                    [disabled]="!reAssignForm.form.valid" [ngClass]="!reAssignForm.form.valid? 'disabled' : ''"
                    (click)=" reAssignTask()"><span class="fa fa-fw fa-reply"></span> Re-Assign
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--Re-Assign Task modal ends-->
